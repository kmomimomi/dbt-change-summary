# 詳細設計

## 技術スタック

PoCの結果と今後の拡張性、メンテナンス性を考慮して、以下の技術スタックを採用します。

### 言語

**TypeScript** を採用します。

理由:
- PoCではJavaScriptが使用されており、実装済みコードとの親和性が高い
- 型安全性によりコードの品質と保守性を向上できる
- GitHub Actions との連携が容易
- ライブラリのエコシステムが豊富

### 利用ライブラリ

#### コア機能

| ライブラリ名 | 用途 | 選定理由 |
|------------|------|---------|
| `@actions/core` | GitHub Actions の基本機能 | GitHub Actionsの標準ライブラリであり、公式サポートされている |
| `@actions/github` | GitHub API連携 | PRコメント、リリース作成などのGitHub操作に必要 |
| `exceljs` | Excel生成 | PoCで実績があり、豊富な機能を持つ |
| `nunjucks` | テンプレート処理 | PoCで実績があり、柔軟なテンプレート機能を提供 |
| `fs-extra` | ファイル操作拡張 | Node.jsの標準FSモジュールを拡張し、非同期処理などが容易 |
| `js-yaml` | YAML処理 | GitHub Actionsの設定ファイル処理などに利用 |

#### 開発環境

| ライブラリ名 | 用途 | 選定理由 |
|------------|------|---------|
| `typescript` | TypeScript 開発環境 | 型付け開発のため |
| `ts-node` | TypeScriptの直接実行 | 開発効率化のため |
| `eslint` | コード品質チェック | 一貫したコーディングスタイルとバグの早期発見 |
| `prettier` | コードフォーマット | コードの可読性と一貫性を保つため |

### 自動テストとCI/CD戦略

#### テスト設計

テストピラミッドに基づき、以下のテスト戦略を採用します。

1. **単体テスト**
   - 対象: 個々の関数、クラス、モジュール
   - 目的: 各コンポーネントが期待通りに動作することを確認
   - 観点:
     - manifest.json解析ロジック
     - 差分抽出ロジック
     - Markdown生成ロジック
     - Excel生成ロジック

2. **結合テスト**
   - 対象: 複数のモジュールが連携する箇所
   - 目的: モジュール間の連携が正しく動作することを確認
   - 観点:
     - manifest解析 → Markdown生成の連携
     - manifest解析 → Excel生成の連携
     - GitHub API連携

3. **E2Eテスト**
   - 対象: GitHub Actionとしての動作
   - 目的: 実際のGitHub環境で期待通りに動作することを確認
   - 観点:
     - PRコメント投稿アクション全体の動作
     - リリース作成アクション全体の動作

#### テストライブラリ

| ライブラリ名 | 用途 | 選定理由 |
|------------|------|---------|
| `jest` | テストフレームワーク | TypeScriptとの統合が容易で機能が豊富 |
| `ts-jest` | JestとTypeScriptの連携 | TypeScriptのテスト実行に必須 |
| `@types/jest` | Jestの型定義 | TypeScriptでのJest利用に必要 |
| `nock` | HTTP通信のモック | GitHub API連携のテスト用 |
| `@actions/github-script` | GitHub Actions内でのスクリプト実行 | E2Eテストに利用 |

#### テストデータの準備方法

1. **フィクスチャデータ**
   - PoCで作成した各種サンプルJSON（manifest.json, catalog.json）を活用
   - テストケースごとにフィクスチャを用意（新規モデル追加、モデル変更、カラム追加など）
   - `__fixtures__` ディレクトリに整理して保存

2. **モック・スタブ**
   - GitHub API連携部分はnockを使ってモック化
   - ファイルシステム操作は`fs-extra`のモック機能を活用

3. **スナップショットテスト**
   - Markdown出力やExcelファイル構造の一貫性をスナップショットテストでチェック

#### CI/CD方法

GitHub Actionsを活用した自動化パイプラインを構築します。

1. **継続的インテグレーション（CI）**
   - トリガー: プルリクエスト作成・更新時
   - ステップ:
     - 依存関係のインストール
     - TypeScriptのコンパイル
     - ESLintによるコード品質チェック
     - 単体テスト・結合テストの実行
     - カバレッジレポートの生成

2. **継続的デプロイメント（CD）**
   - トリガー: mainブランチへのマージ時
   - ステップ:
     - バージョン番号の更新
     - GitHub Releaseの作成
     - GitHub Marketplaceへの公開（必要に応じて）

### ディレクトリ構成

```
dbt-change-summary/
├── .github/                        # GitHub関連設定
│   └── workflows/                  # GitHub Actions ワークフロー定義
│       ├── ci.yml                  # CI用ワークフロー
│       └── release.yml             # リリース用ワークフロー
├── src/                            # ソースコード
│   ├── actions/                    # GitHub Actions定義
│   │   ├── pr-comment/             # PRコメント用アクション
│   │   │   ├── action.yml          # アクション定義
│   │   │   └── index.ts            # エントリーポイント
│   │   └── release-excel/          # リリース用アクション
│   │       ├── action.yml          # アクション定義
│   │       └── index.ts            # エントリーポイント
│   ├── lib/                        # 共通ライブラリ
│   │   ├── manifest-parser.ts      # manifest.json解析
│   │   ├── diff-generator.ts       # 差分抽出
│   │   ├── markdown-renderer.ts    # Markdown生成
│   │   └── excel-generator.ts      # Excel生成
│   └── utils/                      # ユーティリティ
│       ├── github.ts               # GitHub API操作
│       └── file.ts                 # ファイル操作
├── templates/                      # テンプレート
│   ├── pr-comment.md.njk           # PRコメント用テンプレート
│   └── summary.md.njk              # サマリー用テンプレート
├── __fixtures__/                   # テスト用フィクスチャ
│   ├── manifests/                  # テスト用manifest.json
│   └── catalogs/                   # テスト用catalog.json
├── __tests__/                      # テストコード
│   ├── unit/                       # 単体テスト
│   │   ├── manifest-parser.test.ts # manifest解析のテスト
│   │   └── ...
│   ├── integration/                # 結合テスト
│   │   ├── generate-markdown.test.ts # Markdown生成のテスト
│   │   └── ...
│   └── e2e/                        # E2Eテスト
│       ├── pr-comment.test.ts      # PRコメントアクションのテスト
│       └── ...
├── dist/                           # ビルド成果物（.gitignoreに含める）
├── node_modules/                   # 依存関係（.gitignoreに含める）
├── package.json                    # プロジェクト定義・依存関係
├── tsconfig.json                   # TypeScript設定
├── jest.config.js                  # Jestテスト設定
├── .eslintrc.js                    # ESLint設定
├── .prettierrc                     # Prettier設定
├── .gitignore                      # Git除外設定
└── README.md                       # プロジェクト説明
```

## 実装方針

### 1. モジュール分割

コードを以下のように分割して実装します。

1. **マニフェスト解析モジュール**
   - manifest.jsonとcatalog.jsonの読み込みと解析
   - 差分抽出ロジック

2. **出力生成モジュール**
   - Markdown生成ロジック（PRコメント用）
   - Excel生成ロジック（リリース用）

3. **GitHub連携モジュール**
   - PRコメント投稿
   - リリース作成とアセットアップロード

### 2. インターフェース設計

各モジュール間の連携を型安全に行うため、明確なインターフェースを定義します。

```typescript
// マニフェスト解析結果のインターフェース
interface DbtDiff {
  projectDiffs: ProjectDiff[];
  nodeDiffs: NodeDiff[];
}

// PRコメント生成のインターフェース
interface PrCommentOptions {
  markdownTemplate: string;
  diffs: DbtDiff;
}

// Excel生成のインターフェース
interface ExcelReportOptions {
  outputPath: string;
  diffs: DbtDiff;
  manifest: any; // マニフェスト全体
}
```

### 3. エラーハンドリング戦略

1. **予想される例外**
   - マニフェストファイルが存在しない
   - JSONが破損している
   - GitHub APIアクセス失敗

2. **エラー処理アプローチ**
   - 具体的なエラーメッセージを提供
   - 処理の早期段階でバリデーション
   - 適切なログ出力
   - GitHub Actionsでのエラー表示

### 4. デプロイメント戦略

1. **バージョニング**
   - セマンティックバージョニングを採用（MAJOR.MINOR.PATCH）
   - 変更内容に応じたバージョン更新

2. **リリースプロセス**
   - バージョンタグの作成
   - GitHub Releaseの作成
   - 必要に応じてGitHub Marketplaceへの公開

## 今後の拡張性検討

今後の拡張性を考慮して、以下の点に注意して設計・実装を行います。

1. **プラグイン対応**
   - アダプター方式による出力フォーマットの拡張性
   - 差分検出ロジックのカスタマイズ対応

2. **多言語対応**
   - メッセージの国際化
   - 出力フォーマットの言語切り替え

3. **大規模プロジェクト対応**
   - パフォーマンス最適化
   - メモリ効率の改善
   - 差分処理の並列化検討